#
# TODO: store_artifacts
# TODO: mac job
# TODO: improve caching
# TODO: fix `xvfb gulp test` command
# TODO: store_test_results
# TODO: docker images
#

linux: &linux
  working_directory: /home/circleci/mist
  docker:
    - image: circleci/node:8.9.4-browsers
  environment:
      # Setting variable to fix node-gyp build error:
      # https://github.com/nodejs/node/issues/7173#issuecomment-224772258
    - CXX_host: 'g++ -m32'

repository_setup: &repository_setup
  run: 
    name: Git submodules
    command: git submodule update --init --recursive

linux_dependencies: &linux_dependencies
  run:
    name: Linux package dependencies
    # Installing multilib (build for 32 and 64 architectures):
    # https://www.quora.com/How-do-I-fix-fatal-error-sys-cdefs-h-file-not-found-include-sys-cdefs-h
    command: |
      sudo apt-get update &&
      sudo apt-get install --no-install-recommends -y gcc-multilib g++-multilib icnsutils xz-utils &&
      sudo apt-get install graphicsmagick

install_meteor: &install_meteor
  run: 
    name: Installing Meteor
    # PATH=$PATH:$HOME/.meteor && curl -L https://raw.githubusercontent.com/arunoda/travis-ci-meteor-packages/1390e0f96162d0d70fc1e60a6b0f4f891a0e8f42/configure.sh | /bin/sh
    command: which meteor || curl https://install.meteor.com | /bin/sh

install_node_modules: &install_node_modules
  run:
    name: Installing JS dependencies
    command: yarn 

xvfb_setup: &xvfb_setup
  run:
    name: Visual buffer setup
    command: export DISPLAY=:99 && Xvfb -ac :99 -screen 0 1280x1024x16 +extension RANDR > /dev/null 2>&1
    background: true

version: 2
jobs:
  build:
    <<: *linux
    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      # Setting PATH: https://circleci.com/docs/2.0/env-vars/#setting-path
      - run: echo 'export PATH=`yarn global bin`:$PATH' >> $BASH_ENV

      - *repository_setup
      - *linux_dependencies
      - *install_meteor 
      - *install_node_modules

      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - persist_to_workspace:
          root: /home/circleci/
          paths:
            - mist

  mist-linux:
    <<: *linux
    steps:
      - attach_workspace:
          at: /home/circleci/

      - *repository_setup
      - *linux_dependencies
      - *install_meteor 
      - *install_node_modules
      - *xvfb_setup

      - run:
          name: Building Mist for Linux
          command: yarn build:mist --linux

      - run:
          name: Spectron acceptance tests
          command: yarn test:e2e

      - store_artifacts:
          path: dist_mist/release

  wallet-linux:
    <<: *linux
    steps:
      - attach_workspace:
          at: /home/circleci/
          
      - *repository_setup
      - *linux_dependencies
      - *install_meteor 
      - *install_node_modules

      - run:
          name: Building Wallet for Linux
          command: yarn build:wallet --linux

      - store_artifacts:
          path: dist_wallet/release


  unit-test:
    <<: *linux
    steps:
      - attach_workspace:
          at: /home/circleci/

      - *install_node_modules

      - run: 
          name: Running unit tests
          command: yarn test:unit:once

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - mist-linux:
          requires:
            - build
      - wallet-linux:
          requires:
            - build
      - unit-test:
          requires:
            - build
